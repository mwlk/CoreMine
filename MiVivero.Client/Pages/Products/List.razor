@page "/products"
@using MiVivero.Models.Common
@using MiVivero.Models.ViewModels
@using MudBlazor
@inject HttpClient HttpClient

<MudPaper Class="pa-4">
    <MudText Typo="Typo.h5">Productos</MudText>

    <MudProgressCircular Indeterminate="true" Class="my-2" Color="Color.Primary" Style="@(loading ? "" : "display:none")" />

    <MudTextField @bind-Value="searchString" Placeholder="Buscar..." Adornment="Adornment.Start"
                  AdornmentIcon="@Icons.Material.Filled.Search" Class="mb-4" />

    <MudTable T="ProductViewModel" Items="@FilteredProducts" Dense="true" Hover="true" Striped="true" Bordered="true"
              SortLabel="Ordenar por" Breakpoint="Breakpoint.Sm">
        <ToolBarContent>
            <MudText Typo="Typo.h6">Listado de Productos</MudText>
        </ToolBarContent>
        <HeaderContent>
            <MudTh SortBy="(ProductViewModel x) => x.Id">Id</MudTh>
            <MudTh SortBy="(ProductViewModel x) => x.FullCategoryCode">Código</MudTh>
            <MudTh SortBy="(ProductViewModel x) => x.Name">Nombre</MudTh>
            <MudTh>Categoria</MudTh>
        </HeaderContent>
        <RowTemplate>
            <MudTd DataLabel="Id">@context.Id</MudTd>
            <MudTd DataLabel="Código">@context.FullCategoryCode</MudTd>
            <MudTd DataLabel="Nombre">@context.Name</MudTd>
            <MudTd DataLabel="Categoría">@context.CategoryName</MudTd>
        </RowTemplate>
        <PagerContent>
            <MudTablePager PageSize="@pageSize" Page="@currentPage" TotalItems="@totalCount" OnPageChanged="OnPageChanged" />
        </PagerContent>
    </MudTable>
</MudPaper>

@code {
    private List<ProductViewModel>? products;
    private bool loading = false;
    private string searchString = string.Empty;
    private int totalCount = 0;
    private int currentPage = 1;
    private int pageSize = 10;

    protected override async Task OnInitializedAsync()
    {
        loading = true;
        await GetProductsAsync();
        loading = false;
    }

    private async Task GetProductsAsync()
    {
        var response = await HttpClient.GetFromJsonAsync<PagedResult<ProductViewModel>>($"api/products?pageSize={pageSize}&pageNumber={currentPage}");

        if (response != null)
        {
            products = response.Items.ToList();
            totalCount = response.TotalCount;
        }
    }

    private IEnumerable<ProductViewModel> FilteredProducts =>
        string.IsNullOrWhiteSpace(searchString) ? products ?? new List<ProductViewModel>() :
        products!.Where(p =>
            (p.Name?.Contains(searchString, StringComparison.OrdinalIgnoreCase) ?? false) ||
            (p.FullCategoryCode?.Contains(searchString, StringComparison.OrdinalIgnoreCase) ?? false));

    private async Task OnPageChanged(int page)
    {
        currentPage = page;
        loading = true;
        await GetProductsAsync();
        loading = false;
    }
}
