@page "/products"
@using CoreMine.Models.Common
@using CoreMine.Models.ViewModels
@inject HttpClient HttpClient

<MudPaper Class="pa-4">
    <MudText Typo="Typo.h5">Productos</MudText>

    <MudTextField @bind-Value="searchString"
                  Placeholder="Buscar..."
                  Adornment="Adornment.Start"
                  AdornmentIcon="@Icons.Material.Filled.Search"
                  Class="mb-4"
                  Immediate="true"
                  OnBlur="ReloadData"
                  OnKeyUp="@(e => { if (e.Key == "Enter") ReloadData(); })" />

    <MudTable T="ProductViewModel"
              ServerData="LoadServerData"
              RowsPerPageOptions="new int[] { 2, 10, 25, 50, 100 }"
              @bind-CurrentPage="@currentPage"
              @bind-RowsPerPage="@rowsPerPage"
              Bordered="true"
              Hover="true"
              Dense="true"
              Striped="true">
        <ToolBarContent>
            <MudText Typo="Typo.h6">Listado de Productos</MudText>
        </ToolBarContent>

        <HeaderContent>
            <MudTh>Id</MudTh>
            <MudTh>Código</MudTh>
            <MudTh>Nombre</MudTh>
            <MudTh>Categoría</MudTh>
        </HeaderContent>

        <RowTemplate>
            <MudTd DataLabel="Id">@context.Id</MudTd>
            <MudTd DataLabel="Código">@context.FullCategoryCode</MudTd>
            <MudTd DataLabel="Nombre">@context.Name</MudTd>
            <MudTd DataLabel="Categoría">@context.CategoryName</MudTd>
        </RowTemplate>

        <PagerContent>
            <MudTablePager PageSizeOptions="new int[] { 2, 10, 25, 50, 100 }" />
        </PagerContent>
    </MudTable>
</MudPaper>

@code {
    private int currentPage = 0;
    private int rowsPerPage = 2;
    private string searchString = string.Empty;

    private async Task<TableData<ProductViewModel>> LoadServerData(TableState state, CancellationToken cancellationToken)
    {
        currentPage = state.Page;
        rowsPerPage = state.PageSize;

        var pageNumber = currentPage + 1;
        var url = $"api/products?pageNumber={pageNumber}&pageSize={rowsPerPage}";

        if (!string.IsNullOrWhiteSpace(searchString))
            url += $"&Name={Uri.EscapeDataString(searchString)}";

        var response = await HttpClient.GetFromJsonAsync<PagedResult<ProductViewModel>>(url, cancellationToken);

        return new TableData<ProductViewModel>
            {
                TotalItems = response?.TotalCount ?? 0,
                Items = response?.Items ?? new List<ProductViewModel>()
            };
    }

    private async Task ReloadData()
    {
        await Task.Delay(1); // da tiempo a terminar binding del campo
        currentPage = 0;
    }
}
