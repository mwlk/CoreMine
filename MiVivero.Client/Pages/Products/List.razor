@page "/products"
@using MiVivero.Models.ViewModels
@using MudBlazor
@inject HttpClient HttpClient

<MudPaper Class="pa-4">
    <MudText Typo="Typo.h5">Productos</MudText>

    <MudProgressCircular Indeterminate="true" Class="my-2" Color="Color.Primary" Style="@(loading ? "" : "display:none")" />

    <MudTextField @bind-Value="searchString" Placeholder="Buscar..." Adornment="Adornment.Start"
                  AdornmentIcon="@Icons.Material.Filled.Search" Class="mb-4" />

    <MudTable T="ProductViewModel" Items="@FilteredProducts" Dense="true" Hover="true" Striped="true" Bordered="true"
              SortLabel="Ordenar por" Breakpoint="Breakpoint.Sm">
        <ToolBarContent>
            <MudText Typo="Typo.h6">Listado de Productos</MudText>
        </ToolBarContent>
        <HeaderContent>
            <MudTh SortBy="(ProductViewModel x) => x.Id">Id</MudTh>
            <MudTh SortBy="(ProductViewModel x) => x.Code">Código</MudTh>
            <MudTh SortBy="(ProductViewModel x) => x.Name">Nombre</MudTh>
            <MudTh>Categoria</MudTh>
        </HeaderContent>
        <RowTemplate>
            <MudTd DataLabel="Id">@context.Id</MudTd>
            <MudTd DataLabel="Código">@context.Code</MudTd>
            <MudTd DataLabel="Nombre">@context.Name</MudTd>
            <MudTd DataLabel="Categoría">
                @string.Join(" > ", @context.Categories.Select(c => $"{c.Code}-{c.Name}"))
            </MudTd>
        </RowTemplate>
        <PagerContent>
            <MudTablePager />
        </PagerContent>
    </MudTable>
</MudPaper>

@code {
    private List<ProductViewModel>? products;
    private bool loading = false;
    private string searchString = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        loading = true;
        await GetProductsAsync();
        loading = false;
    }

    private async Task GetProductsAsync()
    {
        products = await HttpClient.GetFromJsonAsync<List<ProductViewModel>>("/products");
    }

    // Filtrar productos con base en el searchString
    private IEnumerable<ProductViewModel> FilteredProducts =>
        string.IsNullOrWhiteSpace(searchString) ? products ?? new List<ProductViewModel>() :
        products!.Where(p =>
            (p.Name?.Contains(searchString, StringComparison.OrdinalIgnoreCase) ?? false) ||
            (p.Code?.Contains(searchString, StringComparison.OrdinalIgnoreCase) ?? false));
}
